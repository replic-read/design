In the following, we describe the detailed implementation of the proposed architecture in Chapter~\ref{sec:architecture}.

\subsection{System wide fine design}\label{subsec:system-wide-design}

\subsubsection{Data Transfer Objects (DTOs)}
The \textit{DTO}s are classes that correspond to the request-bodies and response-bodies as declared in the REST-api. \newline
Due to the fact that these classes will be used in all components, i.e.\ server and client, it makes sense to define these as general as possible.
We used only primitive data types and only properties to ensure compatability across all programming languages. \newline
The simplicity of the DTOs allowsus to use automatic serialization from- and into JSON format.
The \textit{DTO}s are visualized in Figure~\ref{fig:dtos}.

\begin{figure}
    \centering
    \fbox{\includegraphics[angle=90,width=\linewidth]{dtos}}

    \caption{Data Transfer Objects}
    \label{fig:dtos}
\end{figure}

\subsubsection{Authentication flow}
Clients will be authenticating themselves with \textit{Json-Web-Tokens} (JWTs) \footnote{https://www.jwt.io/}.

\paragraph{JWTs}
A \textit{JWT} is a string with the following structure: \newline
\begin{center}
    \textit{\textless base64(header)\textgreater.\textless base64(payload)\textgreater.\textless signature\textgreater}
\end{center}

\subparagraph{Header}
The header is a json-object containing the attributes \texttt{alg} ("Algorithm") and \texttt{typ} ("Type of token").
In our case, this header will look like:
\begin{verbatim}
    {
        "alg": "HS256",
        "typ": "jwt"
    }
\end{verbatim}

\subparagraph{Payload}
The payload is a json-object that can contain a selection of attributes.
In our case, the payload will contain the following attributes:
\begin{itemize}
    \item \texttt{iss}: Constant value of \("\)replic-read-server\("\)
    \item \texttt{exp}: ISO-8601 timestamp of the expiration time of the JWT\@.
    \item \texttt{sub}: The id of the account the JWT is created for.
\end{itemize}

\subparagraph{Signature}
The signature is created from the header and payload in the following way: \newline
\begin{center}
    \begin{verbatim}
        HMACSHA256(
        base64(header) + "." +
        base64(payload),
        kessecretret
        )
    \end{verbatim}
\end{center}
where \texttt{secret} is a private key, longer than 256 bits. \newline
Signing the JWT with a private key guarantees the server, that, when presented a JWT by a client, the payload has not been changed.

\paragraph{Logging in}
When a client wants to authenticate, a request with the credentials is sent to \texttt{/auth/login/}.
The server saves a new \textit{refresh-token} and creates a new \textit{JWT} for the client, and returns both these tokens. \newline
Figure~\ref{fig:logging-in} visualizes this flow.

\begin{figure}
    \centering
    \fbox{\includegraphics[width=\linewidth]{logging-in}}

    \caption{Flow for logging in}
    \label{fig:logging-in}
\end{figure}

\paragraph{Using an access-token}
When a client wants to perform a request to an endpoint that requires authentication, the \textit{JWT} is included as the value of the \textit{Bearer} header.
Before the requested action is performed, the server checks whether the JWT is valid and non-expired.
If all checks succeed, the action is performed.
If one of the checks fail, status code \textit{401} or \textit{403} is returned. \newline
Figure~\ref{fig:using-access-token} visualizes this flow.

\begin{figure}
    \centering
    \fbox{\includegraphics[width=\linewidth]{using-access-token}}

    \caption{Flow for accesing a restricted endpoint}
    \label{fig:using-access-token}
\end{figure}

\paragraph{Using a refresh-token}
When a client wants to create a new access-token using an existing refresh-token, it makes a request to \texttt{/auth/refresh/}.
The server receives the refresh-token and checks whether it exists, is non-expired and non-invalidated.
If all checks succeed, a new refresh-token is created and the old one invalidated.
Together with the new refresh-token, a new access-token is generated and returned.
If one of the checks fail, status \textit{401} is sent. \newline
Figure~\ref{fig:using-refresh-token} visualizes this flow.

\begin{figure}
    \centering
    \fbox{\includegraphics[width=\linewidth]{using-refresh-token}}

    \caption{Flow for refreshing}
    \label{fig:using-refresh-token}
\end{figure}

\subsection{Server fine design}\label{subsec:server-fine-design}

\subsubsection{Configuration}
Aside from the server-config that can be set up inside the admin-panel in the web-client, there are configurations that are not domain-related and will not be available on that panel.
The following options can be configured:
\begin{itemize}
    \item \textit{Server domain:} The url without path where the server is running.
    This is required due to the fact that creating the links to the new replic-content requires knowledge of the full URL to the endpoint of \textit{/replic/\{id\}/content/}.
    \item \textit{REST-API path:} The root path where the REST-API will be available.
    \item \textit{Access-Token lifespan length:} The length that an access-token is valid.
    \item \textit{Refresh-Token lifespan length:} The length that a refresh-token is valid.
    \item \textit{Database url:} The url where the database is located.
    \item \textit{Database username} The username to connect to the database.
    \item \textit{Database password} The password to connect to the database.
    \item \textit{Mail from:} The sender of the email.
    \item \textit{Mail username:} The username for email authentication.
    \item \textit{Mail password:} The password for email authentication.
    \item \textit{Mail smtp host:} The smtp host for email authentication.
    \item \textit{Mail smtp port:} The smtp port for email authentication.
    \item \textit{Mail SSL:} Whether to use SSL for email authentication.
\end{itemize}

\subsubsection{Internal server interfaces}
In the following, we will present the fine design of the internal server interfaces, as described in~\ref{subsec:internal-server-interfaces}.

\paragraph{Request-Execution}
The \textbf{Request-Execution} interface provides one method for each endpoint and http-method in the \textit{REST-API}.
The method parameters are either request bodies, query parameters or path variables.
The method return values are the response bodies.\newline
The responsibility of the request executors is to ensure authorization by using the authorizer, handling errors that might occur in the services, and converting the results of the services to the response bodies.
Figure~\ref{fig:inter-executors} gives an overview over the interface.
Multiple request executors are provided to isolate independant themes.

\begin{figure}
    \centering
    \fbox{\includegraphics[width=\linewidth]{inter-executors}}

    \caption{Interface for \textit{Request-Execution}}
    \label{fig:inter-executors}
\end{figure}

\paragraph{Authorization}
The \textbf{Authorization} makes the decisions for whether a client, authenticated or anonymous, is allowed to perform a specific request. \newline
In most cases, this comes down to checking whether a client fulfills the auth group set by the config, or whether the client itself is an admin.
Figure~\ref{fig:inter-authorizer} shows the methods of the authorizer interface.

\begin{figure}
    \centering
    \fbox{\includegraphics{inter-authorizer}}

    \caption{Interface for \textit{Authorization}}
    \label{fig:inter-authorizer}
\end{figure}

\paragraph{Domain-Models}
The domain models are the basic data classes that model the business structure. \newline
To differentiate between a replic that has been linked to a file vs.\ one that hasn't been, \texttt{Replic} is a specific case of \texttt{BaseReplic} that lacks the \texttt{size: long} field.
Figure~\ref{fig:domain-models} shows these classes.

\begin{figure}
    \centering
    \fbox{\includegraphics[width=\linewidth]{domain-models}}

    \caption{Interface for \textit{Domain-Models}}
    \label{fig:domain-models}
\end{figure}

\paragraph{Domain-Services} \label{par:domain-services}
The domain services encapsulate the general logic of the app. \newline
The methods of the services are held simple to keep the spirit of the domain.
To prevent returning complex result types, errors are raised by throwing checked exceptions.
Every specific type of failure has a custom exception type that is explicitly declared on the method to allow targeted handling.
Figure~\ref{fig:domain-services} shows the services and their methods.

\begin{figure}
    \centering
    \fbox{\includegraphics[width=\linewidth]{domain-services}}

    \caption{Interface for \textit{Domain-Services}}
    \label{fig:domain-services}
\end{figure}

\paragraph{Domain-Repositories}\label{par:domain-repositories}
The domain repositories are the way the domain communicates with the database. \newline
Repositories are meant to be a simple interface to queries into a specific table of the relational database.
For most models, it is sufficient to provide the simple methods \texttt{getAll}, \texttt{getById} and \texttt{save}.
Filtering logic is made by the corresponding service.
Figure~\ref{fig:domain-repositories} shows the repository-structure.

\begin{figure}
    \centering
    \fbox{\includegraphics[width=\linewidth]{domain-repositories}}

    \caption{Interface for \textit{Domain-Repositories}}
    \label{fig:domain-repositories}
\end{figure}

\paragraph{Messaging}
The \textbf{Messaging} interface allows to send messages to specified users.
The interface consists of the \textit{EmailSender} as shown in Figure~\ref{fig:domain-messaging}.
Every kind of email corresponds to a method that receives the account to send the email, and required data for the email.

\begin{figure}
    \centering
    \fbox{\includegraphics[width=\linewidth]{domain-messaging}}

    \caption{Interface for \textit{Messaging}}
    \label{fig:domain-messaging}
\end{figure}

\paragraph{I/O}\label{par:io}
The \textbf{I/O} interface allows to access and create the files for storing html-content for replics.
The interface consists of the \textit{ReplicFileAccessor} as shown in Figure~\ref{fig:domain-io}.
Simple methods for creating and reading files are there.

\begin{figure}
    \centering
    \fbox{\includegraphics[width=\linewidth]{domain-io}}

    \caption{Interface for \textit{I/O}}
    \label{fig:domain-io}
\end{figure}

\subsubsection{Request-Execution}
The \textbf{Request-Execution} interface is provided by the classes implementing the interfaces (marked with \textit{*Impl}), as shown in Figure~\ref{fig:inter-executors-d}.
The \texttt{AbstractExecutor} class acts as a super class for the executor-implementations by providing access to the \textit{Domain-Services} interface (see~\ref{par:domain-services}).
The executors use the services to access the data.

\begin{figure}
    \centering
    \fbox{\includegraphics[width=\linewidth]{inter-executors-p}}

    \caption{Provision of \textit{Request-Execution}}
    \label{fig:inter-executors-d}
\end{figure}

\subsubsection{Authorization}
The \textbf{Authorization} interface is provided by the \texttt{RoleGroupBasedAuthorizer}class as shown in~\ref{fig:inter-authorizer-p}.
The class holds a reference to the server-config service (see~\ref{par:domain-services}). \newline
As the name suggests, the implementation is based on roles (for \texttt{canChangeServerConfig} and \texttt{canReviewReports}), and based on admin-checks for the rest.

\begin{figure}
    \centering
    \fbox{\includegraphics{inter-authorizer-p}}

    \caption{Provision of the \textit{Authorizer}}
    \label{fig:inter-authorizer-p}
\end{figure}

\subsubsection{Domain-Repositories}
The \textbf{Domain-Repositories} interface is provided as shown in Figure~\ref{fig:domain-repositories-p}.
We use the \textit{Adapter pattern} \footnote{https://en.wikipedia.org/wiki/Adapter\_pattern} to delegate the calls. \newline
The adaptee is an instance of a \texttt{CrudRepository<E, UUID>} where \texttt{E} is the appropriate entity-class, e.g. \texttt{ReplicEntity}, that is used in JPA to model a record in a database.
To abstrahize the containing of the adaptee, each implementation class extends the \texttt{BaseJpaAdapter<E>} class.

\begin{figure}
    \centering
    \fbox{\includegraphics[width=\linewidth]{domain-repositories-p}}

    \caption{Provision of the \textit{Domain-Repositories}}
    \label{fig:domain-repositories-p}
\end{figure}

\subsubsection{Messaging}
The \textbf{Messaging} interface is provided by the \textit{ApacheEmailSender} class as shown in Figure~\ref{fig:domain-messaging-p}.
The class uses the Apache Commons Email library (see~\ref{subsubsec:commons-email}) to send the emails.
As configuration for the email, the parameters \texttt{from}, \texttt{username}, \texttt{password}, \texttt{smtpHost}, \texttt{smtpPort} and \texttt{sslOnConnect} are provided.

\begin{figure}
    \centering
    \fbox{\includegraphics{domain-messaging-p}}

    \caption{Provision of the \textit{Messaging}}
    \label{fig:domain-messaging-p}
\end{figure}

\subsubsection{I/O}
The \textbf{I/O} interface is provided by the \textit{LocalReplicFileAccessor} class as shown in Figure~\ref{fig:domain-io-p}.
The class uses the standard java File-Api \footnote{https://docs.oracle.com/javase/8/docs/api/java/io/File.html} to write and read the files.
The class is provided the \texttt{rootDirectory} string to determine where on the local device the files are saved.

\begin{figure}
    \centering
    \fbox{\includegraphics{domain-io-p}}

    \caption{Provision of the \textit{I/O}}
    \label{fig:domain-io-p}
\end{figure}

\subsubsection{Domain-Services}
The \textbf{Domain-Services} interface is provided by several implementation classes as shown in Figure~\ref{fig:domain-services-p}. \newline
The \texttt{AccountServiceImpl} and \texttt{ServerConfigServiceImpl} receive the repositories (see~\ref{par:domain-repositories}) they need to access the database records. \newline
The \texttt{ReplicServiceImpl} and \texttt{ReportServiceImpl} are each provided the config service, and the former one the replic file accessor (see~\ref{par:io}). \newline
The \texttt{AuthenticatioNServiceImpl} has access to the token repository, as well as several other services.
This is allowed as no circular definition occurs, and legitimate as authentication is more abstract than the other operations.
Additionally, it is provided the configuration values \texttt{accessTokenExpiration}, \texttt{refreshTokenExpiration} and \texttt{accessTokenSecret} which are required for the authentication setups.

\begin{figure}
    \centering
    \fbox{\includegraphics[width=\linewidth]{domain-services-p}}

    \caption{Provision of the \textit{Domain-Services}}
    \label{fig:domain-services-p}
\end{figure}